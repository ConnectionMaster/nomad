version: 2.1

orbs:
  s3: circleci/aws-s3@1.0.8

references:
  ccc-image: &ccc-image
    circleci/command-convenience:0.1.803-6f4fb54

  hub-auth: &hub-auth
    username: $DOCKER_HUB_USER
    password: $DOCKER_HUB_PASSWORD

jobs:
  download-nomad:
    environment:
      NOMAD_VERSION: 0.9.3
      NOMAD_SHA: cbd008dd2f3c622cb931ce8e7e6465f5b683e66845eb70adb776c970a8029578
    docker:
      - image: circleci/golang:1.12
        user: root
    steps:
      - run:
          name: Download
          command: |
            mkdir -p pkg/linux_amd64
            echo "Downloading Nomad ${NOMAD_VERSION} package"
            curl --location \
            --output pkg/nomad_${NOMAD_VERSION}_linux_amd64.zip \
            "https://releases.hashicorp.com/nomad/${NOMAD_VERSION}/nomad_${NOMAD_VERSION}_linux_amd64.zip"
            echo "${NOMAD_SHA} pkg/nomad_${NOMAD_VERSION}_linux_amd64.zip" | sha256sum -c -
            unzip pkg/nomad_${NOMAD_VERSION}_linux_amd64.zip -d pkg/linux_amd64/
      - persist_to_workspace:
          root: .
          paths:
            - pkg

  upload-to-s3:
    docker:
      - image: circleci/golang:1.12
        user: root
    environment:
      AWS_REGION: us-east-1
    steps:
      - attach_workspace:
          at: .
      - s3/copy:
          from: pkg
          to: 's3://circleci-nomad/'
          aws-region: AWS_REGION
          arguments: |
            --recursive \
            --exclude "*" \
            --include "nomad_*_linux_amd64.zip" \
            --acl public-read

  publish-cloud-container:
    working_directory: /root/nomad
    docker:
      - image: *ccc-image
        auth: *hub-auth
        environment:
          NAME: nomad
          DOCKER_REGISTRY: dockerhub
          DOCKERFILE_PATH: docker/Dockerfile
    steps:
      - checkout
      - setup_remote_docker
      - attach_workspace:
          at: /root/nomad
      - run: publish

  publish-server-container:
    working_directory: /root/nomad
    docker:
      - image: *ccc-image
        auth: *hub-auth
        environment:
          NAME: server-nomad
          DOCKER_REGISTRY: dockerhub
          DOCKERFILE_PATH: docker/Dockerfile.server
    steps:
      - checkout
      - setup_remote_docker
      - attach_workspace:
          at: /root/nomad
      - run: publish

workflows:
  version: 2
  download-and-publish:
    jobs:
      - download-nomad:
          context: org-global
      - upload-to-s3:
          context: org-global
          requires:
            - download-nomad
          filters:
            branches:
              only:
                - master
      - publish-cloud-container:
          context: org-global
          requires:
            - download-nomad
          filters:
            branches:
              only:
                - master
      - publish-server-container:
          context: org-global
          requires:
            - download-nomad
          filters:
            branches:
              only:
                - master
